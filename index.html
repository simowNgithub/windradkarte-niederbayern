<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Interaktive Karte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href= "kartendaten/leaflet.css" />
  <!-- Leaflet Draw CSS -->
  <link rel="stylesheet" href="kartendaten/leaflet.draw.css" />
  <!-- Leaflet JS -->
  <script src="kartendaten/leaflet.js"></script>
  <!-- Leaflet Draw JS -->
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <!-- Leaflet WFS Plugin -->
  <script src="kartendaten/leaflet-wfst.min.js"></script>
 <!-- Leaflet Minimap JS -->
  <script src="kartendaten/Control.MiniMap.min.js"></script>
  <!-- Leaflet Minimap CSS -->
  <link rel="stylesheet" href="kartendaten/Control.MiniMap.min.css" />

  <link rel="stylesheet" href="kartendaten/leaflet-measure.css" />
  <script src="kartendaten/leaflet-measure.js"></script>

  <!-- Leaflet GeometryUtil for area calculations -->
  <script src="https://cdn.jsdelivr.net/npm/leaflet-geometryutil@0.10.1/src/leaflet.geometryutil.js"></script>
																									
<script src="https://unpkg.com/osmtogeojson@3.0.0-beta.4/osmtogeojson.js"></script>


<!-- Eigene Styles -->
  <link rel="stylesheet" href="kartendaten/styles.css" />

</head>
<body>
<div id="address-search-container">
  <input type="text" id="address" placeholder="Adressen/Koordinaten Suche">
  <button onclick="searchAndAddMarker()">Suchen</button>
</div>

  <!-- Mess-Tools Panel -->
  <div class="measure-tools">
    <h4>üîß Messen</h4>
    <button id="measureDistance">üìè Entfernung</button>
    <button id="measureArea">üìê Fl√§che</button>
    <button id="clearMeasure">üóëÔ∏è L√∂schen</button>
    <div id="measureResult" class="measure-result"></div>
  </div>

  <div id="map"></div>

  <!-- Koordinatenanzeige -->
  <div id="coordinates" class="coordinates-display">
    Lat: 0.000000, Lon: 0.000000
  </div>
<div id="context-menu">
  <ul>
    <li id="copy-address">üìç Adresse kopieren</li>
    <li id="copy-coords">üß≠ Koordinaten kopieren</li>
    <li id="copy-elevation">‚õ∞ H√∂henmeter kopieren</li>
    <li id="show-wind">üå¨ Windgeschwindigkeit anzeigen</li>
  </ul>
</div>

<div class="map-direction north">N</div>
<div class="map-direction east">O</div>
<div class="map-direction south">S</div>
<div class="map-direction west">W</div>

  <script>

    // Karte initialisieren
    const map = L.map('map', {
      zoomControl: false // Standard Zoom-Control deaktivieren
    }).setView([48.748, 12.43], 13);

    // Adressen Koordinaten Suche
      function searchAndAddMarker() {
  var address = document.getElementById('address').value;

  if (!address) {
    alert("Bitte eine Adresse eingeben!");
    return;
  }

  fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(address))
    .then(response => response.json())
    .then(data => {
      if (data && data.length > 0) {
        var lat = parseFloat(data[0].lat);
        var lon = parseFloat(data[0].lon);
        var marker = L.marker([lat, lon]).addTo(map);
        marker.bindPopup(address).openPopup();
        map.setView([lat, lon], 14);
      } else {
        alert("Adresse nicht gefunden: " + address);
      }
    })
    .catch(err => {
      alert("Fehler bei der Anfrage: " + err);
    });
}
    // Rechtsklick Men√º
  const mapContainer = document.getElementById('map');
  const contextMenu = document.getElementById('context-menu');
  let clickedLatLng = null;
  let lastAddress = '';
  let lastCoords = '';
  let lastElevation = 'unbekannt';

  async function fetchElevation(lat, lon) {
    try {
      // Open-Elevation API
      const res = await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lon}`);
      const data = await res.json();
      if (data && data.results && data.results[0] && typeof data.results[0].elevation === 'number') {
        return data.results[0].elevation + " m";
      }
    } catch {
      // Fehler ignorieren
    }
    return "unbekannt";
  }

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
      alert("Inhalt kopiert:\n" + text);
      hideContextMenu();
    }, () => {
      alert("Kopieren fehlgeschlagen");
      hideContextMenu();
    });
  }

  function hideContextMenu() {
    contextMenu.style.display = 'none';
  }

  map.on('contextmenu', async function(e) {
    e.originalEvent.preventDefault();

    clickedLatLng = e.latlng;
    lastCoords = `${clickedLatLng.lat.toFixed(6)}, ${clickedLatLng.lng.toFixed(6)}`;

    try {
      const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${clickedLatLng.lat}&lon=${clickedLatLng.lng}`);
      const data = await res.json();
      lastAddress = data.display_name || "Keine Adresse gefunden";
    } catch {
      lastAddress = "Fehler beim Abrufen der Adresse";
    }

    lastElevation = await fetchElevation(clickedLatLng.lat, clickedLatLng.lng);

    const containerPoint = map.latLngToContainerPoint(clickedLatLng);
    contextMenu.style.top = containerPoint.y + 'px';
    contextMenu.style.left = containerPoint.x + 'px';
    contextMenu.style.display = 'block';
  });

  document.getElementById('copy-address').addEventListener('click', () => {
    copyToClipboard(lastAddress);
  });

  document.getElementById('copy-coords').addEventListener('click', () => {
    copyToClipboard(lastCoords);
  });

  document.getElementById('copy-elevation').addEventListener('click', () => {
    copyToClipboard(lastElevation);
  });

  document.getElementById('show-wind').addEventListener('click', async () => {
    if (!clickedLatLng) return;

    try {
      const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${clickedLatLng.lat}&longitude=${clickedLatLng.lng}&hourly=windspeed_200m`);
      const data = await res.json();
      let windspeed = "unbekannt";

      if (data.hourly && data.hourly.windspeed_200m && data.hourly.time) {
        const times = data.hourly.time;
        const now = new Date();
        let idx = times.findIndex(t => {
          const tDate = new Date(t);
          return tDate.getHours() === now.getHours() && tDate.getDate() === now.getDate();
        });
        if (idx === -1) idx = 0;
        windspeed = data.hourly.windspeed_200m[idx] + " km/h";
      }

      L.popup()
        .setLatLng(clickedLatLng)
        .setContent(`<b>Windgeschwindigkeit (200m):</b> ${windspeed}`)
        .openOn(map);

    } catch {
      alert("Fehler beim Abrufen der Winddaten");
    }

    hideContextMenu();
  });

  map.getContainer().addEventListener('click', () => {
    hideContextMenu();
  });

  window.addEventListener('keydown', (e) => {
    if (e.key === "Escape") {
      hideContextMenu();
    }
  });

// MiniMap
const miniMap = new L.Control.MiniMap(
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: ''
  }),
  {
    toggleDisplay: true,
    minimized: false,
    position: 'topright'
  }
).addTo(map);

    // Zoom-Control rechts unten hinzuf√ºgen
    L.control.zoom({
      position: 'bottomright'
    }).addTo(map);

    // Koordinatenanzeige
    const coordinatesDiv = document.getElementById('coordinates');

    map.on('mousemove', function(e) {
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      coordinatesDiv.innerHTML = `Lat: ${lat}, Lon: ${lng}`;
    });

    const tiereDaten = [
    { art: 'Digitalis purpurea', artDeutsch: 'Roter Fingerhut', artgruppe: 'H√∂here Pflanzen', datum: '2020-06-16', anzahl: 100, lat: 48.765864, lon: 12.395582 },
    { art: 'Milvus milvus', artDeutsch: 'Rotmilan', artgruppe: 'V√∂gel', datum: '2024-09-11', anzahl: 2, lat: 48.763009, lon: 12.379937 },
    { art: 'Milvus milvus', artDeutsch: 'Rotmilan', artgruppe: 'V√∂gel', datum: '2024-06-13', anzahl: 1, lat: 48.769317, lon: 12.371761 },
    { art: 'Pernis apivorus', artDeutsch: 'Wespenbussard', artgruppe: 'V√∂gel', datum: '2024-07-12', anzahl: 2, lat: 48.768206, lon: 12.393755 },
    { art: 'Strix aluco', artDeutsch: 'Waldkauz', artgruppe: 'V√∂gel', datum: '2020-05-30', anzahl: 1, lat: 48.75946, lon: 12.389941 },
    { art: 'Asio otus', artDeutsch: 'Waldohreule', artgruppe: 'V√∂gel', datum: '2024-07-10', anzahl: null, lat: 48.766263, lon: 12.378136 },
    { art: 'Muscicapa striata', artDeutsch: 'Grauschn√§pper', artgruppe: 'V√∂gel', datum: '2017-05-26', anzahl: 2, lat: 48.766089, lon: 12.37663 },
    { art: 'Certhia familiaris', artDeutsch: 'Waldbauml√§ufer', artgruppe: 'V√∂gel', datum: '2016-03-16', anzahl: 1, lat: 48.765095, lon: 12.382191 },
    { art: 'Jynx torquilla', artDeutsch: 'Wendehals', artgruppe: 'V√∂gel', datum: '2019-05-01', anzahl: 1, lat: 48.764847, lon: 12.381623 },
    { art: 'Acherontia atropos', artDeutsch: 'Totenkopf', artgruppe: 'Tag- und Nachtfalter', datum: '2017-06-19', anzahl: 1, lat: 48.765979, lon: 12.377014 },
    { art: 'Linaria cannabina', artDeutsch: 'Bluth√§nfling', artgruppe: 'V√∂gel', datum: '2015-06-22', anzahl: 2, lat: 48.765905, lon: 12.376753 },
    { art: 'Carduelis carduelis', artDeutsch: 'Stieglitz', artgruppe: 'V√∂gel', datum: '2017-05-25', anzahl: 2, lat: 48.765583, lon: 12.377568 },
    { art: 'Circus pygargus', artDeutsch: 'Wiesenweihe', artgruppe: 'V√∂gel', datum: '2019-06-07', anzahl: 2, lat: 48.775922, lon: 12.372546 },
    { art: 'Emberiza citrinella', artDeutsch: 'Goldammer', artgruppe: 'V√∂gel', datum: '2017-04-21', anzahl: 1, lat: 48.765078, lon: 12.382788 },
    { art: 'Lanius collurio', artDeutsch: 'Neunt√∂ter', artgruppe: 'V√∂gel', datum: '2015-05-08', anzahl: 2, lat: 48.766303, lon: 12.377851 },
    { art: 'Lacerta agilis', artDeutsch: 'Zauneidechse', artgruppe: 'Eidechsen u. Schlangen (Lacertidae und Serpentes)', datum: '2019-06-05', anzahl: 1, lat: 48.765857, lon: 12.377377 },
    { art: 'Lacerta agilis', artDeutsch: 'Zauneidechse', artgruppe: 'Eidechsen u. Schlangen (Lacertidae und Serpentes)', datum: '2016-05-08', anzahl: 1, lat: 48.767586, lon: 12.379986 },
    { art: 'Dendrocoptes medius', artDeutsch: 'Mittelspecht', artgruppe: 'V√∂gel', datum: '2015-04-23', anzahl: 1, lat: 48.764854, lon: 12.382057 },
    { art: 'Troglodytes troglodytes', artDeutsch: 'Zaunk√∂nig', artgruppe: 'V√∂gel', datum: '2019-10-26', anzahl: 1, lat: 48.76488, lon: 12.381952 },
    { art: 'Dryocopus martius', artDeutsch: 'Schwarzspecht', artgruppe: 'V√∂gel', datum: '2024-07-31', anzahl: null, lat: 48.763727, lon: 12.376275 },
    { art: 'Nyctalus noctula', artDeutsch: 'Gro√üer Abendsegler', artgruppe: 'Flederm√§use (Chiroptera)', datum: '2024-07-09', anzahl: 1, lat: 48.765584, lon: 12.381488 },
    { art: 'Milvus milvus', artDeutsch: 'Rotmilan', artgruppe: 'V√∂gel', datum: '2025-03-15', anzahl: 1, lat: 48.78878537571216, lon: 12.35859387721311 },
    { art: 'Ciconia ciconia', artDeutsch: 'Wei√üstorch', artgruppe: 'V√∂gel', datum: '2025-05-29', anzahl: 1, lat: 48.72670393477358, lon: 12.401228852428838 },
{ art: 'Ciconia ciconia', artDeutsch: 'Wei√üstorch', artgruppe: 'V√∂gel', datum: '2025-05-29', anzahl: 1, lat: 48.751585, lon: 12.195762 },
    { art: 'Falco tinnunculus', artDeutsch: 'Turmfalke', artgruppe: 'V√∂gel', datum: '2025-04-20', anzahl: 2, lat: 48.72532719826952, lon: 12.357817747996055 },
    { art: 'Falco tinnunculus', artDeutsch: 'Junger Turmfalke', artgruppe: 'V√∂gel', datum: '2024-06-13', anzahl: 1, lat: 48.725517, lon: 12.358291 },
    { art: 'Buteo buteo', artDeutsch: 'M√§usebussard', artgruppe: 'V√∂gel', datum: '2025-04-20', anzahl: 1, lat: 48.725919, lon: 12.358249 },
    { art: 'Accipiter nisus', artDeutsch: 'Sperber', artgruppe: 'V√∂gel', datum: '2024-04-12', anzahl: 1, lat: 48.724702, lon: 12.358710 },
    { art: 'Milvus milvus', artDeutsch: 'Rotmilan', artgruppe: 'V√∂gel', datum: '2025-06-14', anzahl: 1, lat: 48.7246645, lon: 12.3590508 },
    { art: 'Falco tinnunculus', artDeutsch: 'Turmfalke', artgruppe: 'V√∂gel', datum: '2025-06-16', anzahl: 6, lat: 48.776389, lon: 12.154535 },
    { art: 'Falco tinnunculus', artDeutsch: 'Turmfalke', artgruppe: 'V√∂gel', datum: '2025-06-16', anzahl: 4, lat: 48.777033, lon: 12.155758 },
{ art: 'Milvus milvus', artDeutsch: 'Rotmilan', artgruppe: 'V√∂gel', datum: '2025-07-13', anzahl: 2, lat: 48.724650, lon: 12.359903 },
{ art: 'Milvus milvus', artDeutsch: 'Rotmilan', artgruppe: 'V√∂gel', datum: '2025-07-12', anzahl: 1, lat: 48.724024, lon: 12.356926 },
{ art: 'Milvus milvus', artDeutsch: 'Rotmilan', artgruppe: 'V√∂gel', datum: '2025-07-10', anzahl: 1, lat: 48.724757, lon: 12.363278 },
{ art: 'Milvus milvus', artDeutsch: 'Rotmilan', artgruppe: 'V√∂gel', datum: '2025-07-10', anzahl: 1, lat: 48.756173, lon: 12.167006 },
{ art: 'Ciconia ciconia', artDeutsch: 'Wei√üstorch', artgruppe: 'V√∂gel', datum: '2025-05-29', anzahl: 2, lat: 48.773099, lon: 12.183643 },
    ];

    // Windr√§der-Daten
    const windr√§der = [
    { nr: 1, lat: 48.734246, lon: 12.372727, farbe: 'yellow', park: 'Windpark 1 (JUWI)' },
    { nr: 2, lat: 48.72735, lon: 12.3744, farbe: 'yellow', park: 'Windpark 1 (JUWI)' },
    { nr: 3, lat: 48.73108, lon: 12.376065, farbe: 'yellow', park: 'Windpark 1 (JUWI)' },
    { nr: 4, lat: 48.733353, lon: 12.385371, farbe: 'yellow', park: 'Windpark 1 (JUWI)' },
    { nr: 1, lat: 48.76162245070192, lon: 12.32720457448543, farbe: 'blue', park: 'Windpark 2 (Primus)' },
    { nr: 2, lat: 48.75597936866052, lon: 12.337604234589673, farbe: 'blue', park: 'Windpark 2 (Primus)' },
    { nr: 3, lat: 48.75268348499753, lon: 12.327707863808396, farbe: 'blue', park: 'Windpark 2 (Primus)' },
    { nr: 4, lat: 48.74896408408048, lon: 12.334664962515475, farbe: 'blue', park: 'Windpark 2 (Primus)' },
    { nr: 5, lat: 48.74110281366956, lon: 12.341455859921119, farbe: 'blue', park: 'Windpark 2 (Primus)' },
    { nr: 6, lat: 48.7338913546195, lon: 12.34486206232525, farbe: 'blue', park: 'Windpark 2 (Primus)' },
{ nr: 1, lat: 48.78088, lon: 12.39447, farbe: 'red', park: 'Windpark 3 (Herrmann)' },
{ nr: 2, lat: 48.77864, lon: 12.40066, farbe: 'red', park: 'Windpark 3 (Herrmann)' },
{ nr: 3, lat: 48.77760, lon: 12.38326, farbe: 'red', park: 'Windpark 3 (Herrmann)' },
{ nr: 4, lat: 48.77349, lon: 12.39594, farbe: 'red', park: 'Windpark 3 (Herrmann)' },
{ nr: 5, lat: 48.76880, lon: 12.39526, farbe: 'red', park: 'Windpark 3 (Herrmann)' },
{ nr: 6, lat: 48.77131, lon: 12.40833, farbe: 'red', park: 'Windpark 3 (Herrmann)' },
{ nr: 7, lat: 48.75467, lon: 12.38984, farbe: 'red', park: 'Windpark 3 (Herrmann)' },
{ nr: 8, lat: 48.75001, lon: 12.38972, farbe: 'red', park: 'Windpark 3 (Herrmann)' },
{ nr: 9, lat: 48.74054, lon: 12.35948, farbe: 'red', park: 'Windpark 3 (Herrmann)' },
    { nr: 1, lat: 48.750637268186914, lon: 12.155367023131237, farbe: 'gray', park: 'Windpark 4 (JUWI)' },
    { nr: 2, lat: 48.75706065405235, lon: 12.152498571257748, farbe: 'gray', park: 'Windpark 4 (JUWI)' },
    { nr: 3, lat: 48.76132119693771, lon: 12.149282746603689, farbe: 'gray', park: 'Windpark 4 (JUWI)' },
    { nr: 4, lat: 48.76602828074706, lon: 12.152499212424551, farbe: 'gray', park: 'Windpark 4 (JUWI)' },
    { nr: 5, lat: 48.76124314532713, lon: 12.164311967658676, farbe: 'gray', park: 'Windpark 4 (JUWI)' },
	
	{ nr: 1, lat: 48.723636, lon: 12.489175, farbe: 'white', park: 'Windpark 5 (JUWI)' },	
    { nr: 2, lat: 48.719056, lon: 12.487258, farbe: 'white', park: 'Windpark 5 (JUWI)' },
    { nr: 3, lat: 48.716803, lon: 12.492106, farbe: 'white', park: 'Windpark 5 (JUWI)' },
    { nr: 1, lat: 48.8440813247077, lon: 12.359145485472046, farbe: 'orange', park: 'Windpark 6 (UNENDLICH ENERGIE)' },
    { nr: 2, lat: 48.845555368316504, lon: 12.3521541576846, farbe: 'orange', park: 'Windpark 6 (UNENDLICH ENERGIE)' },
    { nr: 3, lat: 48.83992829061574, lon: 12.35311653288946, farbe: 'orange', park: 'Windpark 6 (UNENDLICH ENERGIE)' },
    { nr: 4, lat: 48.83710502833099, lon: 12.355393618652881, farbe: 'orange', park: 'Windpark 6 (UNENDLICH ENERGIE)' },
    { nr: 5, lat: 48.82793893487388, lon: 12.340270171689285, farbe: 'orange', park: 'Windpark 6 (UNENDLICH ENERGIE)' },
    { nr: 6, lat: 48.82754162109488, lon: 12.333723190701702, farbe: 'orange', park: 'Windpark 6 (UNENDLICH ENERGIE)' },
    { nr: 7, lat: 48.82545275997033, lon: 12.306464051724399, farbe: 'orange', park: 'Windpark 6 (UNENDLICH ENERGIE)' },
    { nr: 8, lat: 48.82248375555308, lon: 12.308404099666037, farbe: 'orange', park: 'Windpark 6 (UNENDLICH ENERGIE)' },
    { nr: 1, lat: 48.72388170390228, lon: 12.311048327385334, farbe: 'black', park: 'Windpark 7 (KOLLER)' },
    { nr: 2, lat: 48.71857600327504, lon: 12.310788079055413, farbe: 'black', park: 'Windpark 7 (KOLLER)' },
    { nr: 1, lat: 48.740060245087534, lon: 12.265816337239311, farbe: 'green', park: 'Windpark 8 (JUWI)' },
    { nr: 2, lat: 48.7353745689905, lon: 12.268615979244487, farbe: 'green', park: 'Windpark 8 (JUWI)' },
    { nr: 3, lat: 48.72509473571516, lon: 12.268482650850736, farbe: 'green', park: 'Windpark 8 (JUWI)' },
    { nr: 4, lat: 48.724021541397256, lon: 12.25715890438672, farbe: 'green', park: 'Windpark 8 (JUWI)' },
    { nr: 5, lat: 48.72533348436944, lon: 12.260327563369302, farbe: 'green', park: 'Windpark 8 (JUWI)' },
    { nr: 1, lat: 48.8686952616524, lon: 12.396411736548476, farbe: 'brown', park: 'Windpark 9 (ALTERRIC)' },
    { nr: 2, lat: 48.86655095601276, lon: 12.388251980709065, farbe: 'brown', park: 'Windpark 9 (ALTERRIC)' },
    { nr: 3, lat: 48.85786742664067, lon: 12.391750805681868, farbe: 'brown', park: 'Windpark 9 (ALTERRIC)' },
    { nr: 4, lat: 48.85331609620429, lon: 12.386864085342962, farbe: 'brown', park: 'Windpark 9 (ALTERRIC)' },
    { nr: 5, lat: 48.8523056524615, lon: 12.379516486908742, farbe: 'brown', park: 'Windpark 9 (ALTERRIC)' },
    { nr: 6, lat: 48.851016188803236, lon: 12.376264288189658, farbe: 'brown', park: 'Windpark 9 (ALTERRIC)' },
    { nr: 7, lat: 48.85365097290565, lon: 12.367049121749575, farbe: 'brown', park: 'Windpark 9 (ALTERRIC)' },
    ];

    // Funktion zur Erstellung eines benutzerdefinierten Icons f√ºr Windr√§der
    function createWindradIcon(number, colorClass) {
    return L.divIcon({
    className: `windrad-marker windrad-${colorClass}`,
    html: number,
    iconSize: [20, 20],
    iconAnchor: [15, 15],
    });
    }				  

						  
// Overpass-API Query f√ºr 110kV/220kV Umspannwerke in Bayern
    var overpassUrl = 'https://overpass-api.de/api/interpreter?data=[out:json][timeout:25];area["name"="Bayern"]->.searchArea;(node["power"="substation"]["voltage"~"^(110000|220000)(;|$)"](area.searchArea);way["power"="substation"]["voltage"~"^(110000|220000)(;|$)"](area.searchArea);relation["power"="substation"]["voltage"~"^(110000|220000)(;|$)"](area.searchArea););out center;';

    // SVG-Icon als Data-URL (Blitzsymbol)
    function createSvgIcon(color) {
      var svg = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="12" fill="${color}" stroke="white" stroke-width="2"/>
          <polygon points="13,3 4,14 11,14 11,21 20,10 13,10" fill="yellow" stroke="black" stroke-width="1"/>
        </svg>
      `;
      return L.icon({
        iconUrl: 'data:image/svg+xml;base64,' + btoa(svg),
        iconSize: [32, 32],
        iconAnchor: [16, 16],
        popupAnchor: [0, -16],
        className: ''
      });
    }

// Layer f√ºr Umspannwerke (wird sp√§ter bef√ºllt)
var umspannwerkeLayer = L.layerGroup();
var loadedUmspannwerkeBounds = null;
var isLoadingUmspannwerke = false;

function loadUmspannwerke() {
  if (isLoadingUmspannwerke) return;

  var bounds = map.getBounds();
  var south = bounds.getSouth();
  var west = bounds.getWest();
  var north = bounds.getNorth();
  var east = bounds.getEast();

  // Pr√ºfen ob schon geladen
  if (loadedUmspannwerkeBounds && loadedUmspannwerkeBounds.contains(bounds)) {
    return;
  }

  isLoadingUmspannwerke = true;

  // Query nur f√ºr sichtbaren Bereich
  var overpassQuery = `[out:json][timeout:15];
    (
    node["power"="substation"]["voltage"~"^(110000|220000)(;|$)"](${south},${west},${north},${east});
    way["power"="substation"]["voltage"~"^(110000|220000)(;|$)"](${south},${west},${north},${east});
    relation["power"="substation"]["voltage"~"^(110000|220000)(;|$)"](${south},${west},${north},${east});
    );
    out center;`;

  var overpassUrl = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(overpassQuery);

  fetch(overpassUrl)
    .then(response => {
      if (!response.ok) {
        throw new Error('Netzwerkantwort war nicht ok: ' + response.statusText);
      }
      return response.text();
    })
    .then(text => {
      try {
        const data = JSON.parse(text);

        // Bestehende Marker l√∂schen
        umspannwerkeLayer.clearLayers();

        // Umwandlung von Overpass JSON zu GeoJSON
        function overpassToGeoJSON(osmData) {
          var geojson = {
            type: "FeatureCollection",
            features: []
          };
          osmData.elements.forEach(function(el) {
            var coords = null;
            if (el.type === "node") {
              coords = [el.lon, el.lat];
            } else if (el.type === "way" && el.center) {
              coords = [el.center.lon, el.center.lat];
            } else if (el.type === "relation" && el.center) {
              coords = [el.center.lon, el.center.lat];
            }
            if (coords) {
              geojson.features.push({
                type: "Feature",
                geometry: {
                  type: "Point",
                  coordinates: coords
                },
                properties: el.tags || {}
              });
            }
          });
          return geojson;
        }

        var geojson = overpassToGeoJSON(data);

        // GeoJSON-Layer erzeugen und zum LayerGroup hinzuf√ºgen
        L.geoJSON(geojson, {
          pointToLayer: function (feature, latlng) {
            var voltage = feature.properties.voltage || "";
            var color = voltage.includes("220000") ? "#e53935" : "#2196f3";
            return L.marker(latlng, { icon: createSvgIcon(color) });
          },
          onEachFeature: function (feature, layer) {
            var name = feature.properties.name || "Umspannwerk";
            var voltage = feature.properties.voltage || "unbekannt";
            var voltageText = voltage.replace(/110000/g, "110 kV").replace(/220000/g, "220 kV");
            layer.bindPopup("<b>" + name + "</b><br>Spannung: " + voltageText);
          }
        }).addTo(umspannwerkeLayer);

        loadedUmspannwerkeBounds = bounds;
        isLoadingUmspannwerke = false;
      } catch (e) {
        console.error("Fehler beim Parsen der Umspannwerke:", e.message);
        console.error("Antworttext:", text.substring(0, 200) + "...");
        isLoadingUmspannwerke = false;
      }
    })
    .catch(err => {
      console.error("Fehler beim Laden der Umspannwerke:", err);
      isLoadingUmspannwerke = false;
    });
}

// Event Listener f√ºr Kartenverschiebung
map.on('moveend', function() {
  if (map.getZoom() >= 10) { // Nur ab bestimmtem Zoom-Level laden
    loadUmspannwerke();
  } else {
    umspannwerkeLayer.clearLayers();
    loadedUmspannwerkeBounds = null;
  }
});
// LayerGroups f√ºr die Leitungen
var lines110 = L.layerGroup();
var lines220 = L.layerGroup();
var loadedLinesBounds = null;
var isLoadingLines = false;

function loadStromleitungen() {
  if (isLoadingLines) return;

  var bounds = map.getBounds();
  var south = bounds.getSouth();
  var west = bounds.getWest();
  var north = bounds.getNorth();
  var east = bounds.getEast();

  // Pr√ºfen ob schon geladen
  if (loadedLinesBounds && loadedLinesBounds.contains(bounds)) {
    return;
  }

  isLoadingLines = true;

  // Query nur f√ºr sichtbaren Bereich
  var overpassQuery = `[out:json][timeout:15];
    (
    way["power"="line"]["voltage"~"110000"](${south},${west},${north},${east});
    way["power"="line"]["voltage"~"220000"](${south},${west},${north},${east});
    );
    out geom;`;

  var overpassUrl = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(overpassQuery);

  fetch(overpassUrl)
    .then(response => {
      if (!response.ok) {
        throw new Error('Netzwerkantwort war nicht ok: ' + response.statusText);
      }
      return response.text();
    })
    .then(text => {
      try {
        const data = JSON.parse(text);

        // Bestehende Linien l√∂schen
        lines110.clearLayers();
        lines220.clearLayers();

        // Hilfsfunktion: Overpass-JSON zu GeoJSON f√ºr Linien
        function overpassToGeoJSON(osmData, voltageFilter) {
          var geojson = {
            type: "FeatureCollection",
            features: []
          };
          osmData.elements.forEach(function(el) {
            if (el.type === "way" && el.geometry && el.tags && el.tags.voltage && el.tags.voltage.includes(voltageFilter)) {
              var coords = el.geometry.map(function(pt) { return [pt.lon, pt.lat]; });
              geojson.features.push({
                type: "Feature",
                geometry: {
                  type: "LineString",
                  coordinates: coords
                },
                properties: el.tags
              });
            }
          });
          return geojson;
        }

        // 110kV-Leitungen (blau)
        var geojson110 = overpassToGeoJSON(data, "110000");
        L.geoJSON(geojson110, {
          style: { color: "#2196f3", weight: 3 },
          onEachFeature: function (feature, layer) {
            var voltage = feature.properties.voltage.replace(/110000/g, "110 kV");
            layer.bindPopup("Leitung<br>Spannung: " + voltage);
          }
        }).addTo(lines110);

        // 220kV-Leitungen (rot)
        var geojson220 = overpassToGeoJSON(data, "220000");
        L.geoJSON(geojson220, {
          style: { color: "#e53935", weight: 3 },
          onEachFeature: function (feature, layer) {
            var voltage = feature.properties.voltage.replace(/220000/g, "220 kV");
            layer.bindPopup("Leitung<br>Spannung: " + voltage);
          }
        }).addTo(lines220);

        loadedLinesBounds = bounds;
        isLoadingLines = false;
      } catch (e) {
        console.error("Fehler beim Parsen der Leitungen:", e.message);
        isLoadingLines = false;
      }
    })
    .catch(err => {
      console.error("Fehler beim Laden der Leitungen:", err);
      isLoadingLines = false;
    });
}

// Event Listener f√ºr Stromleitungen
map.on('moveend', function() {
  if (map.getZoom() >= 11) { // Nur ab bestimmtem Zoom-Level laden
    loadStromleitungen();
  } else {
    lines110.clearLayers();
    lines220.clearLayers();
    loadedLinesBounds = null;
  }
});

      // LayerGroup f√ºr Naturschutzgebiete
    var nsgLayer = L.layerGroup();

      // Overpass-API Query f√ºr Naturschutzgebiete in Bayern
    var overpassNSGUrl = 'https://overpass-api.de/api/interpreter?data=[out:json][timeout:25];area["name"="Bayern"]->.searchArea;(way["boundary"="protected_area"]["protection_title"~"Naturschutzgebiet"](area.searchArea);relation["boundary"="protected_area"]["protection_title"~"Naturschutzgebiet"](area.searchArea);way["protect_class"="4"](area.searchArea);relation["protect_class"="4"](area.searchArea););out geom;';

fetch(overpassNSGUrl)
  .then(response => {
    if (!response.ok) {
      throw new Error('Netzwerkantwort war nicht ok: ' + response.statusText);
    }
    return response.text(); // erst als Text lesen
  })
  .then(text => {
    try {
      const data = JSON.parse(text); // versuche JSON zu parsen
      // ... hier deine Verarbeitung mit data ...
      function overpassToGeoJSON(osmData) {
        var geojson = {
          type: "FeatureCollection",
          features: []
        };
        osmData.elements.forEach(function(el) {
          if ((el.type === "way" || el.type === "relation") && el.geometry) {
            var coords = el.geometry.map(function(pt) { return [pt.lon, pt.lat]; });
            geojson.features.push({
              type: "Feature",
              geometry: {
                type: "Polygon",
                coordinates: [coords]
              },
              properties: el.tags
            });
          }
        });
        return geojson;
      }
      var geojson = overpassToGeoJSON(data);
      L.geoJSON(geojson, {
        style: {
          color: "#0000ff",
          fillColor: "#0090d3",
          fillOpacity: 0.5,
          weight: 1
        },
        onEachFeature: function (feature, layer) {
          var name = feature.properties.name || "Naturschutzgebiet";
          layer.bindPopup("<b>" + name + "</b>");
        }
      }).addTo(nsgLayer);
    } catch (e) {
      alert("Fehler beim Parsen der Naturschutzgebiete: " + e.message);
      console.error("Antworttext:", text);
    }
  })
  .catch(err => {
    alert("Fehler beim Laden der Naturschutzgebiete: " + err.message);
  });

// Layer f√ºr Denkm√§ler aus OSM
var denkmaleLayer = L.layerGroup();
var loadedBounds = null;
var isLoading = false;

function loadDenkmaeler() {
  if (isLoading) return;

  var bounds = map.getBounds();
  var south = bounds.getSouth();
  var west = bounds.getWest();
  var north = bounds.getNorth();
  var east = bounds.getEast();

  // Pr√ºfen ob schon geladen
  if (loadedBounds && loadedBounds.contains(bounds)) {
    return;
  }

  isLoading = true;

  var overpassQuery = `[out:json][timeout:15];
    (
      node["historic"](${south},${west},${north},${east});
      way["historic"](${south},${west},${north},${east});
      relation["historic"](${south},${west},${north},${east});
    );
    out center;`;

  var overpassUrl = 'https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(overpassQuery);

  fetch(overpassUrl)
    .then(response => response.json())
    .then(data => {
      // Bestehende Marker l√∂schen
      denkmaleLayer.clearLayers();

      var geojson = overpassToGeoJSON(data);

      L.geoJSON(geojson, {
        pointToLayer: function(feature, latlng) {
          return L.marker(latlng, {
            icon: L.divIcon({
              className: 'denkmal-icon',
              html: '<span style="font-size: 25px;">üèõÔ∏è</span>',
              iconSize: [30, 30],
              iconAnchor: [15, 15]
            })
          });
        },
        onEachFeature: function(feature, layer) {
          var props = feature.properties || {};
          var name = props.name || "Denkmal";
          var ref = props.ref || props['ref:denkmal'] || "keine Aktennummer";
          var heritage = props.heritage || "kein Denkmalstatus";
          var description = props.description || "";
          var lat = feature.geometry.coordinates[1];
          var lon = feature.geometry.coordinates[0];

          var denkmalatlasUrl = `https://geoportal.bayern.de/denkmalatlas/index.html?zoom=15&lat=${lat}&lon=${lon}`;

          var popupContent = `<b>${name}</b><br>
                              Aktennummer: ${ref}<br>
                              Status: ${heritage}<br>
                              ${description}<br>
                              <a href="${denkmalatlasUrl}" target="_blank" rel="noopener noreferrer">Denkmalatlas Bayern</a>`;

          layer.bindPopup(popupContent);
        }
      }).addTo(denkmaleLayer);

      loadedBounds = bounds;
      isLoading = false;
    })
    .catch(err => {
      console.error("Fehler beim Laden der Denkm√§ler:", err);
      isLoading = false;
    });
}

function overpassToGeoJSON(osmData) {
  var geojson = {
    type: "FeatureCollection",
    features: []
  };
  osmData.elements.forEach(function(el) {
    var coords = null;
    if (el.type === "node") {
      coords = [el.lon, el.lat];
    } else if ((el.type === "way" || el.type === "relation") && el.center) {
      coords = [el.center.lon, el.center.lat];
    }
    if (coords) {
      geojson.features.push({
        type: "Feature",
        geometry: {
          type: "Point",
          coordinates: coords
        },
        properties: el.tags || {}
      });
    }
  });
  return geojson;
}

// Event Listener f√ºr Kartenverschiebung
map.on('moveend', function() {
  if (map.getZoom() >= 12) { // Nur ab bestimmtem Zoom-Level laden
    loadDenkmaeler();
  } else {
    denkmaleLayer.clearLayers();
    loadedBounds = null;
  }
});

    // Funktion zur Erstellung eines benutzerdefinierten Icons f√ºr verschiedene Artgruppen
    function createArtenIcon(tier) {
    let className, emoji;

    if (tier.artgruppe.includes('V√∂gel')) {
    className = 'vogel-icon';
    if (tier.artDeutsch.includes('Rotmilan') || tier.artDeutsch.includes('Wiesenweihe')) {
    emoji = 'ü¶Ö';
    } else if (tier.artDeutsch.includes('Kauz') || tier.artDeutsch.includes('Eule')) {
    emoji = 'ü¶â';
    } else if (tier.artDeutsch.includes('Specht')) {
    emoji = 'üê¶';
    } else {
    emoji = 'üê¶';
    }
    }
    else if (tier.artgruppe.includes('Pflanzen')) {
    className = 'pflanze-icon';
    emoji = 'üåπ';
    }
    else if (tier.artgruppe.includes('Eidechsen') || tier.artgruppe.includes('Schlangen')) {
    className = 'reptil-icon';
    emoji = 'ü¶é';
    }
    else if (tier.artgruppe.includes('Falter')) {
    className = 'insekt-icon';
    emoji = 'ü¶ã';
    }
    else if (tier.artgruppe.includes('Flederm√§use')) {
    className = 'fledermaus-icon';
    emoji = 'ü¶á';
    }
    else {
    className = 'tier-icon';
    emoji = 'üêæ';
    }

    return L.divIcon({
    className: className,
    html: emoji,
    iconSize: [25, 25],
    iconAnchor: [15, 15]
    });
    }

    // Layer f√ºr Gruppierung erstellen
    const windr√§derLayer = L.layerGroup();
    const v√∂gelLayer = L.layerGroup();
    const s√§ugetierLayer = L.layerGroup();
    const pflanzenLayer = L.layerGroup();
    const reptilienLayer = L.layerGroup();
    const insektenLayer = L.layerGroup();

    // Marker f√ºr Windr√§der setzen
    windr√§der.forEach(wr => {
    const colorClass = wr.farbe === 'red' ? 'red' :
    wr.farbe === 'yellow' ? 'yellow' :
    wr.farbe === 'blue' ? 'blue' :
    wr.farbe === 'white' ? 'white' :
    wr.farbe === 'brown' ? 'brown' :
    wr.farbe === 'black' ? 'black' :
    wr.farbe === 'orange' ? 'orange' :
    wr.farbe === 'green' ? 'green' :
    'gray';
    L.marker([wr.lat, wr.lon], {
    icon: createWindradIcon(wr.nr, colorClass)
    })
    .addTo(windr√§derLayer)
    .bindPopup(`Windrad Nr. ${wr.nr}<br>${wr.park}`);
    });

    // Tiermarker hinzuf√ºgen - jetzt mit direkten WGS84-Koordinaten
    tiereDaten.forEach(tier => {
    if (!tier.lat || !tier.lon) return;

    let layer;
    if (tier.artgruppe.includes('V√∂gel')) {
    layer = v√∂gelLayer;
    } else if (tier.artgruppe.includes('Pflanzen')) {
    layer = pflanzenLayer;
    } else if (tier.artgruppe.includes('Eidechsen') || tier.artgruppe.includes('Schlangen')) {
    layer = reptilienLayer;
    } else if (tier.artgruppe.includes('Falter')) {
    layer = insektenLayer;
    } else if (tier.artgruppe.includes('Flederm√§use')) {
    layer = s√§ugetierLayer;
    } else {
    layer = insektenLayer;
    }

    const marker = L.marker([tier.lat, tier.lon], {
    icon: createArtenIcon(tier)
    })
    .bindPopup(`
    <strong>${tier.artDeutsch} (${tier.art})</strong><br>
    Artgruppe: ${tier.artgruppe}<br>
    Datum: ${tier.datum}<br>
    ${tier.anzahl ? 'Anzahl: ' + tier.anzahl : ''}
    `);

    marker.addTo(layer);
    });

    // Nur die Windr√§der-Layergruppe zur Karte hinzuf√ºgen
    windr√§derLayer.addTo(map);
// WMS-Layer f√ºr Windr√§der
const windraederWMSLayer = L.tileLayer.wms("https://www.lfu.bayern.de/gdi/wms/energieatlas/windenergieanlagen?", {
    layers: 'windenergieanlagen',
    format: 'image/png',
    transparent: true,
    version: '1.3.0',
    attribution: 'Bayerisches Landesamt f√ºr Umwelt'
});

	  // WMS-Layer f√ºr Windvorranggebiete aus den Metadaten hinzuf√ºgen
    const windvorranggebiete = L.tileLayer.wms("https://www.lfu.bayern.de/gdi/wms/energieatlas/planungsgrundlagen_wind?", {
    layers: 'gebietskul_wind_2024_zoom1,gebietskul_wind_2024_zoom2', // Die relevanten Layer aus den Metadaten
    format: 'image/png',
    transparent: true,
    version: '1.3.0',
    attribution: 'Bayerisches Landesamt f√ºr Umwelt'
});

// Biotopkartierung WMS-Layer
    var biotopWMS = L.tileLayer.wms('https://www.lfu.bayern.de/gdi/wms/natur/biotopkartierung?', {
      layers: 'default,bio_sbk,bio_abk',
      format: 'image/png',
      transparent: true,
      version: '1.1.1', // oder 1.3.0, je nach Dienst
      crs: L.CRS.EPSG3857, // Leaflet verwendet standardm√§√üig EPSG:3857
      attribution: '¬© LfU Bayern'
});

// WMS-Layer f√ºr Warngebiete auf Gemeindebasis
const dwdWarnGebieteGemeinden = L.tileLayer.wms('https://maps.dwd.de/geoserver/dwd/wms', {
  layers: 'dwd:Warngebiete_Gemeinden',  // Warngebiete auf Gemeindebasis
  format: 'image/png',
  transparent: true,
  attribution: '¬© Deutscher Wetterdienst'
});

// WMS-Layer f√ºr Warngebiete auf Kreisbasis
const dwdWarnGebieteKreise = L.tileLayer.wms('https://maps.dwd.de/geoserver/dwd/wms', {
  layers: 'dwd:Warngebiete_Kreise',  // Warngebiete auf Kreisbasis
  format: 'image/png',
  transparent: true,
  attribution: '¬© Deutscher Wetterdienst'
});

// Forstliche Standortskartierung Bayern
const staatswaldLayer = L.tileLayer.wms('https://www.baysf.de/geodaten/ows?', {
  layers: 'baysf:Staatswald',
  format: 'image/png',
  transparent: true,
  version: '1.3.0',
  attribution: '¬© Bayerische Staatsforsten A√∂R',
  crs: L.CRS.EPSG3857  // Leider nutzlos, weil der Server nur EPSG:25832 spricht!
});

const waldfunktionWMS = L.tileLayer.wms('https://www.fovgis.bayern.de/arcgis/services/fov/waldfunktionskarte/MapServer/WmsServer?', {
  layers: '0', // Layer 0 = Waldfunktionskarte (laut Capabilities)
  format: 'image/png',
  transparent: true,
  version: '1.3.0',
  attribution: '¬© Bayerische Forstverwaltung / FoVGIS'
});

    // WMS-Layer vom Energieatlas (Windatlas 2021)
    const windatlas = L.tileLayer.wms('https://www.lfu.bayern.de/gdi/wms/energieatlas/windatlas2021?', {
    layers: 'Windatlas2021_mittlere_Windgeschwindigkeit_100m', // Layername laut Capabilities
    format: 'image/png',
    transparent: true,
    version: '1.3.0',
    attribution: '&copy; Bayerisches Landesamt f√ºr Umwelt'
    });

  // Legende mit Auf-/Zuklapp-Funktion (jetzt links)
  const legendContainer = L.DomUtil.create('div', 'legend-container');
  legendContainer.innerHTML = `
    <div class="legend-toggle">
    <span>Legende</span>
    <span class="toggle-icon">‚ñæ</span>
    </div>
    <div class="legend-content">
		    <p>----Windparks/Windr√§der----</p>
    <div class="legende-item">
    <span class="legende-farbe windrad-yellow"></span> Windpark 1 (JUWI)
    </div>
    <div class="legende-item">
    <span class="legende-farbe windrad-blue"></span> Windpark 2 (Primus)
    </div>
    <div class="legende-item">
    <span class="legende-farbe windrad-red"></span> Windpark 3 (Herrmann)
    </div>
    <div class="legende-item">
    <span class="legende-farbe windrad-gray"></span> Windpark 4 (JUWI)
    </div>
    <div class="legende-item">
    <span class="legende-farbe windrad-white"></span> Windpark 5 (JUWI)
    </div>
    <div class="legende-item">
    <span class="legende-farbe windrad-orange"></span> Windpark 6 (UNENDLICH ENERGIE)
    </div>
    <div class="legende-item">
    <span class="legende-farbe windrad-black"></span> Windpark 7 (KOLLER)
    </div>
    <div class="legende-item">
    <span class="legende-farbe windrad-green"></span> Windpark 8 (JUWI)
    </div>
    <div class="legende-item">
    <span class="legende-farbe windrad-brown"></span> Windpark 9 (ALTERRIC)
    </div>
    <div class="legende-item">
    <span style="background: yellow; width: 12px; height: 12px; display: inline-block; border: 1px solid #000000"></span> Windpark 10
    </div>
    <div class="legende-item">
    <span style="background: blue; width: 12px; height: 12px; display: inline-block; border: 1px solid #000000;"></span> Windpark 11
    </div>
    <div class="legende-item">
    <img src="kartendaten/images/windradicon.png" width="17">&nbsp;Vorhandene Windr√§der
    </div>
	  	    <p>----Kartenmarkierungen----</p>
    <div class="legende-item">
    <span class="legende-symbol">üê¶-ü¶Ö-ü¶â</span> V√∂gel-Greifv√∂gel-Eulen
    </div>
    <div class="legende-item">
    <span class="legende-symbol">ü¶é</span> Reptilien
    </div>
    <div class="legende-item">
    <span class="legende-symbol">ü¶ã</span> Insekten
    </div>
    <div class="legende-item">
    <span class="legende-symbol">ü¶á</span> Flederm√§use
    </div>
    <div class="legende-item">
    <span class="legende-symbol">üåπ</span> Pflanzen
    </div>
    <div class="legende-item">
    <span class="legende-symbol">üèõÔ∏è</span> Denkm√§ler
    </div>
	    <p>----Windvorranggebiete----</p>
	    <div class="legende-item">
    <span style="background: #22a822; width: 15px; height: 15px; display: inline-block; border: 1px solid #2b8c3e;"></span>&nbsp;Geeignete Fl√§chen ab 5,5ms Windh√∂ffigkeit
    </div>
    <div class="legende-item">
    <span style="background: #44d844; width: 15px; height: 15px; display: inline-block; border: 1px solid #2b8c3e;"></span>&nbsp;Geeignete Fl√§chen ab 4,8ms Windh√∂ffigkeit
    </div>
    <div class="legende-item">
    <span style="background: #fbfb53; width: 15px; height: 15px; display: inline-block; border: 1px solid #2b8c3e;"></span>&nbsp;Bedingt Geeignete Fl√§chen
    </div>
    <div class="legende-item">
    <span style="background: #ffb82b; width: 15px; height: 15px; display: inline-block; border: 1px solid #2b8c3e;"></span>&nbsp;In der Regel nicht geeignete Fl√§chen
    </div>
    <div class="legende-item">
    <span style="background: #c9ebeb; width: 15px; height: 15px; display: inline-block; border: 1px solid #2b8c3e;"></span>&nbsp;Nicht untersucht zu geringe Windh√∂ffigkeit
    </div>
    </div>
  `;
  // Zur Karte hinzuf√ºgen
  map.getContainer().appendChild(legendContainer);

  // Klappfunktion hinzuf√ºgen
  const toggleButton = legendContainer.querySelector('.legend-toggle');
  const toggleIcon = legendContainer.querySelector('.toggle-icon');
  const legendContent = legendContainer.querySelector('.legend-content');

  let isCollapsed = false;

  toggleButton.addEventListener('click', function() {
    isCollapsed = !isCollapsed;
    if (isCollapsed) {
    legendContent.classList.add('collapsed');
    toggleIcon.classList.add('collapsed');
    } else {
    legendContent.classList.remove('collapsed');
    toggleIcon.classList.remove('collapsed');
    }
  });

    // Basiskarten
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '¬© OpenStreetMap-Mitwirkende'
    });

    const cartoLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap & Carto',
    subdomains: 'abcd',
    maxZoom: 19
    });

    const cartoDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap & Carto',
    subdomains: 'abcd',
    maxZoom: 19
    });

    const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: '&copy; Esri, DigitalGlobe, GeoEye',
    maxZoom: 19
    });

    const opentopo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
    maxZoom: 17,
    attribution: 'Kartendaten: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>, SRTM | Darstellung: &copy; <a href="https://opentopomap.org">OpenTopoMap</a>'
  });
  const googleStreets = L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
    attribution: '&copy; Google'
  });
  const googleSatellite = L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
    attribution: '&copy; Google'
  });
  const googleHybrid = L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
    attribution: '&copy; Google'
  });
  const googleTerrain = L.tileLayer('https://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
    maxZoom: 20,
    subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
    attribution: '&copy; Google'
  });
    const esriLabels = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}', {
    attribution: 'Labels ¬© Esri',
    maxZoom: 19
    });

    // Gruppierter Layer f√ºr Satellit + Beschriftung
    const esriSatWithLabels = L.layerGroup([esriSat, esriLabels]);

    // Standardkarte
    osm.addTo(map);

// Layer-Control mit allen Layern
L.control.layers({
  "OpenStreetMap": osm,
  "Satelliten Karte (Esri)": esriSatWithLabels,
  "Topografische Karte (Opentopo)": opentopo,
  "Carto Light": cartoLight,
  "Carto Dark": cartoDark,
  "Google Streets": googleStreets,
  "Google Satellite": googleSatellite,
  "Google Hybrid": googleHybrid,
  "Google Terrain": googleTerrain,

}, {
  "Geplante Windr√§der": windr√§derLayer,
  "Vorhandene Windr√§der": windraederWMSLayer,
  "Windvorranggebiete (Ladezeit)": windvorranggebiete,
  "V√∂gel": v√∂gelLayer,
  "Pflanzen": pflanzenLayer,
  "Reptilien": reptilienLayer,
  "Insekten": insektenLayer,
  "Flederm√§use": s√§ugetierLayer,
  "Denkm√§ler": denkmaleLayer,
  "Windwarnungen Gemeinden": dwdWarnGebieteGemeinden,
  "Windwarnungen Kreise": dwdWarnGebieteKreise,
  "Umspannwerke 110kV/220kV": umspannwerkeLayer,
  "Hochspannungsleitungen 110kV": lines110,
  "Hochspannungsleitungen 220 kV": lines220,
  "Naturschutzgebiete": nsgLayer,
  //"Ã∂BÃ∂iÃ∂oÃ∂tÃ∂oÃ∂pÃ∂kÃ∂aÃ∂rÃ∂tÃ∂iÃ∂eÃ∂rÃ∂uÃ∂nÃ∂gÃ∂ Ã∂BÃ∂aÃ∂yÃ∂eÃ∂rÃ∂nÃ∂": biotopWMS,
  //"Ã∂SÃ∂tÃ∂aÃ∂aÃ∂tÃ∂sÃ∂fÃ∂oÃ∂rÃ∂sÃ∂tÃ∂eÃ∂nÃ∂ Ã∂(Ã∂BÃ∂aÃ∂yÃ∂SÃ∂FÃ∂)Ã∂": staatswaldLayer,
  //"Ã∂WÃ∂aÃ∂lÃ∂dÃ∂fÃ∂uÃ∂nÃ∂kÃ∂tÃ∂iÃ∂oÃ∂nÃ∂sÃ∂kÃ∂aÃ∂rÃ∂tÃ∂eÃ∂" : waldfunktionWMS,
  //"Ã∂WÃ∂iÃ∂nÃ∂dÃ∂gÃ∂eÃ∂sÃ∂cÃ∂hÃ∂wÃ∂iÃ∂nÃ∂dÃ∂iÃ∂gÃ∂kÃ∂eÃ∂iÃ∂tÃ∂eÃ∂nÃ∂": windatlas
}, {
  collapsed: true // Optional: Control standardm√§√üig ausgeklappt
}).addTo(map);

    // Karte auf die gesamten sichtbaren Layer zoomen
    const bounds = L.latLngBounds();

    // Alle Windr√§der zur Bounding Box hinzuf√ºgen
    windr√§der.forEach(wr => {
    bounds.extend([wr.lat, wr.lon]);
    });

    // Alle Tiere zur Bounding Box hinzuf√ºgen
    tiereDaten.forEach(tier => {
    if (tier.lat && tier.lon) {
    bounds.extend([tier.lat, tier.lon]);
    }
    });

    // Karte auf alle Punkte zentrieren
    if (!bounds.isValid()) {
    map.setView([48.748, 12.43], 13);
    } else {
    map.fitBounds(bounds.pad(0.1));
    }

    // Mess-Funktionalit√§t
    let measureLayer = L.layerGroup().addTo(map);
    let currentMeasureMode = null;
    let measurePath = [];
    let measurePolyline = null;
    let measurePolygon = null;
    let measureMarkers = [];

    // Measure-Tools Event-Handler
    document.getElementById('measureDistance').addEventListener('click', function() {
      clearMeasurements();
      setMeasureMode('distance');
      updateButtonStates(this);
    });

    document.getElementById('measureArea').addEventListener('click', function() {
      clearMeasurements();
      setMeasureMode('area');
      updateButtonStates(this);
    });

    document.getElementById('clearMeasure').addEventListener('click', function() {
      clearMeasurements();
      setMeasureMode(null);
      updateButtonStates(null);
      document.getElementById('measureResult').style.display = 'none';
    });

    function updateButtonStates(activeButton) {
      document.querySelectorAll('.measure-tools button').forEach(btn => {
        btn.classList.remove('active');
      });
      if (activeButton) {
        activeButton.classList.add('active');
      }
    }

    function setMeasureMode(mode) {
      currentMeasureMode = mode;
      if (mode) {
        map.getContainer().style.cursor = 'crosshair';
      } else {
        map.getContainer().style.cursor = '';
      }
    }

    function clearMeasurements() {
      measureLayer.clearLayers();
      measurePath = [];
      measurePolyline = null;
      measurePolygon = null;
      measureMarkers = [];
    }

    // Karten-Click Handler f√ºr Messungen
    map.on('click', function(e) {
      if (!currentMeasureMode) return;

      const latlng = e.latlng;
      measurePath.push(latlng);

      // Marker f√ºr Messpunkt hinzuf√ºgen
      const marker = L.circleMarker(latlng, {
        radius: 4,
        fillColor: '#ff7800',
        color: '#000',
        weight: 1,
        opacity: 1,
        fillOpacity: 0.8
      }).addTo(measureLayer);
      measureMarkers.push(marker);

      if (currentMeasureMode === 'distance') {
        handleDistanceMeasure();
      } else if (currentMeasureMode === 'area') {
        handleAreaMeasure();
      }
    });

    function handleDistanceMeasure() {
      if (measurePath.length >= 2) {
        // Polyline aktualisieren oder erstellen
        if (measurePolyline) {
          measureLayer.removeLayer(measurePolyline);
        }

        measurePolyline = L.polyline(measurePath, {
          color: '#ff7800',
          weight: 3,
          opacity: 0.8
        }).addTo(measureLayer);

        // Entfernung berechnen
        let totalDistance = 0;
        for (let i = 1; i < measurePath.length; i++) {
          totalDistance += measurePath[i-1].distanceTo(measurePath[i]);
        }

        displayMeasureResult(formatDistance(totalDistance));
      }
    }

    function handleAreaMeasure() {
      if (measurePath.length >= 3) {
        // Polygon aktualisieren oder erstellen
        if (measurePolygon) {
          measureLayer.removeLayer(measurePolygon);
        }

        measurePolygon = L.polygon(measurePath, {
          color: '#ff7800',
          weight: 2,
          opacity: 0.8,
          fillColor: '#ff7800',
          fillOpacity: 0.2
        }).addTo(measureLayer);

        // Fl√§che berechnen (approximativ mit Leaflet's built-in Methode)
        const area = L.GeometryUtil.geodesicArea(measurePath);
        displayMeasureResult(formatArea(area));
      }
    }

    function formatDistance(meters) {
      if (meters >= 1000) {
        return (meters / 1000).toFixed(2) + ' km';
      } else {
        return meters.toFixed(1) + ' m';
      }
    }

    function formatArea(squareMeters) {
      if (squareMeters >= 10000) {
        return (squareMeters / 10000).toFixed(2) + ' ha';
      } else if (squareMeters >= 1000000) {
        return (squareMeters / 1000000).toFixed(2) + ' km¬≤';
      } else {
        return squareMeters.toFixed(1) + ' m¬≤';
      }
    }

   // function displayMeasureResult(result) {
   //   const resultDiv = document.getElementById('measureResult');
   //   resultDiv.innerHTML = 'Ergebnis: ' + result;
   //   resultDiv.style.display = 'block';
   // }

function displayMeasureResult(result) {
  const resultDiv = document.getElementById('measureResult');
  resultDiv.innerHTML = result; // "Ergebnis: " entfernt
  resultDiv.style.display = 'block';
}
    // Doppelklick beendet Messung
    map.on('dblclick', function(e) {
      if (currentMeasureMode) {
        setMeasureMode(null);
        updateButtonStates(null);
        map.getContainer().style.cursor = '';
      }
    });

    // ESC-Taste bricht Messung ab
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && currentMeasureMode) {
        clearMeasurements();
        setMeasureMode(null);
        updateButtonStates(null);
        document.getElementById('measureResult').style.display = 'none';
      }
    });

  </script>
</body>
</html>
